
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- CSP: allow file: for img/audio previews -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: file:; media-src 'self' file:; script-src 'self' 'unsafe-inline'; child-src 'self'; frame-src 'self' file:;" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pixel Game Maker</title>
  <style>
    /* Masterball theme */
    :root{
      --bg:#1a1730;
      --panel:#201b3d;
      --muted:#2b2450;
      --text:#e5e7eb;
      --accent:#9d3fb0;
      --danger:#ef4444;
      --topbar-bg:#C40E56;   /* Masterball top bar */
      --sidebar-bg:#402843;  /* Masterball sidebar */
      --work-bg:#2C274E;     /* Masterball main area */
      --sub:#c9c9d6;
    }
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font-family:Segoe UI,Roboto,system-ui,Arial,sans-serif}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--muted);background: var(--topbar-bg)}
    .title{font-weight:700}
    .actions button{margin-left:6px;padding:8px 10px;border-radius:10px;border:1px solid var(--muted);background:#0e1524;color:var(--text);cursor:pointer}
    .actions button:hover{border-color:var(--accent)}
    .layout{display:grid;grid-template-columns:260px 1fr;height:calc(100vh - 86px)}
    .sidebar{border-right:1px solid var(--muted);padding:8px;overflow:auto;background: var(--sidebar-bg)}
    .group{margin-bottom:14px}
    .group h3{margin:8px 4px;font-size:12px;color:#9ca3af;font-weight:600;text-transform:uppercase;letter-spacing:.08em}
    .module{display:flex;align-items:center;justify-content:space-between;padding:10px;margin:6px 0;border:1px solid var(--muted);border-radius:12px;background:#0d1423}
    .module button{padding:6px 8px;border-radius:8px;border:1px solid var(--muted);background:#0a1220;color:#fff;cursor:pointer}
    .module button:hover{border-color:var(--accent)}
    .name{font-size:14px}
    .work{position:relative;background: var(--work-bg)}
    iframe{position:absolute;inset:0;width:100%;height:100%;border:0;display:none}
    .empty{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#e0d7ea;font-size:14px}
    .status{padding:8px 12px;border-top:1px solid var(--muted);background:#6f1d46;font-size:12px;color:#ffe4f1}

    /* Assets modern UI */
    .assets{display:none;height:100%;grid-template-rows:auto 1fr}
    .toolbar{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--muted);background:#5a1b3c;align-items:center}
    .toolbar button,.toolbar .badge{padding:6px 10px;border-radius:10px;border:1px solid var(--muted);background:#341334;color:#fff;cursor:pointer}
    .toolbar .badge{cursor:default}
    .sp{flex:1}
    .input,.select{padding:6px 10px;border:1px solid var(--muted);border-radius:10px;background:#2a1831;color:#fff}

    .main{display:grid;grid-template-columns:1fr 320px;gap:12px;padding:12px;height:calc(100% - 46px)}
    .view{display:grid;grid-template-columns:repeat(auto-fill, minmax(180px,1fr));gap:12px;align-content:start;overflow:auto}
    .card{position:relative;background:var(--panel);border:1px solid var(--muted);border-radius:12px;overflow:hidden;outline:none;display:flex;flex-direction:column}
    .card:focus{box-shadow:0 0 0 2px var(--accent)}
    .pick{position:absolute;top:8px;left:8px;z-index:1;background:rgba(0,0,0,.3);backdrop-filter:blur(2px);padding:4px;border-radius:8px;border:1px solid #273449}
    .sel{width:16px;height:16px}
    .thumb{aspect-ratio:1/1;display:block;background:#0b1220}
    .thumb img{width:100%;height:100%;display:block;object-fit:contain;image-rendering:pixelated}
    .thumb.nonimg{font-size:54px;line-height:1}
    .meta{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-top:1px solid var(--muted)}
    .meta .n{max-width:64%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .meta .s{color:var(--sub);font-size:12px}

    .list{display:none;overflow:auto}
    .row{display:grid;grid-template-columns:34px 1fr 120px 120px;gap:8px;align-items:center;border-bottom:1px solid #0f172a;padding:8px 6px}
    .row.header{color:#e7cde3;font-size:12px;font-weight:700;position:sticky;top:0;background:#5a1b3c;border-bottom:1px solid var(--muted)}
    .row .name{display:flex;align-items:center;gap:10px;min-width:0}
    .row .name img{width:28px;height:28px;object-fit:cover;image-rendering:pixelated;border-radius:6px;border:1px solid #182236;background:#0b1220}

    .side{border-left:1px solid var(--muted);padding-left:12px;overflow:auto}
    .panel{background:#2b214e;border:1px solid var(--muted);border-radius:12px;overflow:hidden}
    .side .head{padding:10px 12px;border-bottom:1px solid var(--muted);background:#5a1b3c;display:flex;justify-content:space-between;align-items:center}
    .side .body{padding:10px 12px}
    .pre{white-space:pre-wrap;background:#0b1220;border:1px solid #152033;border-radius:8px;padding:8px;overflow:auto}

    /* Context menu */
    .menu{position:fixed;min-width:180px;background:#2b214e;border:1px solid #223045;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:6px;display:none;z-index:9999}
    .menu.open{display:block}
    .menu button{display:block;width:100%;text-align:left;background:none;border:none;color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer}
    .menu button:hover{background:#33265c}
    .menu .danger{color:#ffb4b4}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="title">Pixel Game Maker</div>
    <div class="actions">
      <button id="btnAdd">Add Module (.html)</button>
      <button id="btnOpenFolder" title="Open modules folder in Explorer">Open Modules Folder</button>
      <button id="btnSettings" title="Open Settings">Settings</button>
    </div>
  </header>

  <main class="layout">
    <aside class="sidebar">
      <div class="group">
        <h3>Assets</h3>
        <div class="module">
          <div class="name">Open Assets</div>
          <button id="btnOpenAssets">Open</button>
        </div>
      </div>
      <div class="group">
        <h3>Modules</h3>
        <div id="moduleList"></div>
      </div>
    </aside>

    <section class="work">
      <div id="assetsPanel" class="assets">
        <div class="toolbar">
          <button id="btnUp">Up</button>
          <button id="btnNewFolder">New Folder</button>
          <label for="filePicker" class="badge">Upload</label>
          <input id="filePicker" type="file" style="display:none"/>
          <button id="btnOpenAssetsFolder">Open Assets Folder</button>
          <button id="btnChangeAssets">Change Location</button>
          <div class="sp"></div>
          <input id="search" class="input" placeholder="Search name…"/>
          <select id="filter" class="select">
            <option value="all">All</option>
            <option value="image">Images</option>
            <option value="audio">Audio</option>
            <option value="data">Data</option>
            <option value="other">Other</option>
          </select>
          <button id="toggleView">List View</button>
          <span id="count" class="badge"></span>
        </div>

        <div class="main">
          <div class="left">
            <div id="grid" class="view"></div>
            <div id="list" class="list">
              <div class="row header"><div></div><div>Name</div><div>Type/Size</div><div>Modified</div></div>
            </div>
          </div>

          <aside class="side">
            <div class="panel">
              <div class="head"><strong>Inspector</strong><span id="selCount" class="badge">0 selected</span></div>
              <div class="body" id="inspector"><div style="color:#e0d7ea">Select a file to preview. Right-click for actions.</div></div>
            </div>
          </aside>
        </div>
      </div>

      <iframe id="toolFrame" title="Tool Viewer"></iframe>
      <div id="emptyState" class="empty">Welcome. Open <span class="link" id="linkAssets" style="text-decoration:underline;cursor:pointer">Assets</span> or add a module to begin.</div>
    </section>
  </main>

  <footer class="status" id="status">Ready.</footer>

  <!-- Context menu -->
  <div id="ctx" class="menu" role="menu" aria-hidden="true">
    <button data-act="open">Open</button>
    <button data-act="rename">Rename…</button>
    <button data-act="move">Move…</button>
    <button data-act="duplicate">Duplicate</button>
    <button data-act="delete" class="danger">Delete</button>
  </div>

  <script>
    const listEl = document.getElementById('moduleList');
    const frameEl = document.getElementById('toolFrame');
    const emptyEl = document.getElementById('emptyState');
    const statusEl = document.getElementById('status');

    // Assets UI elements
    const assetsPanel = document.getElementById('assetsPanel');
    const gridEl = document.getElementById('grid');
    const listViewEl = document.getElementById('list');
    const countEl = document.getElementById('count');
    const inspector = document.getElementById('inspector');
    const selCount = document.getElementById('selCount');
    const searchEl = document.getElementById('search');
    const filterEl = document.getElementById('filter');
    const ctx = document.getElementById('ctx');
    let ctxTarget = null;

    const btnOpenAssets = document.getElementById('btnOpenAssets');
    const btnUp = document.getElementById('btnUp');
    const btnNewFolder = document.getElementById('btnNewFolder');
    const filePicker = document.getElementById('filePicker');
    const btnOpenAssetsFolder = document.getElementById('btnOpenAssetsFolder');
    const btnChangeAssets = document.getElementById('btnChangeAssets');
    const linkAssets = document.getElementById('linkAssets');
    const toggleViewBtn = document.getElementById('toggleView');

    const btnAdd = document.getElementById('btnAdd');
    const btnOpenFolder = document.getElementById('btnOpenFolder');

    function setStatus(msg){ statusEl.textContent = msg; }

    // -------- Modules ----------
    async function refreshList(){
      const modules = await window.AppAPI.listModules();
      listEl.innerHTML = '';
      if (!modules.length){
        const p = document.createElement('p'); p.style.color = '#e0d7ea';
        p.textContent = 'No modules yet. Click "Add Module" to pick an .html tool.';
        listEl.appendChild(p);
      }
      for (const m of modules){
        const row = document.createElement('div'); row.className = 'module';
        const name = document.createElement('div'); name.className = 'name'; name.textContent = m.name;
        const openBtn = document.createElement('button'); openBtn.textContent = 'Open'; openBtn.onclick = () => openModule(m.id);
        const delBtn = document.createElement('button'); delBtn.textContent = 'Delete'; delBtn.onclick = async () => {
          if (!confirm(`Remove module "${m.name}"?`)) return;
          const res = await window.AppAPI.removeModule(m.id);
          if (res.ok){ setStatus('Module removed.'); refreshList(); showEmpty(); }
          else setStatus('Error: ' + (res.message||'failed'));
        };
        const right = document.createElement('div'); right.appendChild(openBtn); right.appendChild(delBtn);
        row.appendChild(name); row.appendChild(right); listEl.appendChild(row);
      }
    }
    async function openModule(id){
      const res = await window.AppAPI.resolveModuleUrl(id);
      if (!res.ok){ setStatus('Error: ' + (res.message||'failed')); return; }
      assetsPanel.style.display = 'none';
      frameEl.src = res.url; frameEl.style.display = 'block'; emptyEl.style.display = 'none'; setStatus('Module loaded.');
    }
    function showEmpty(){ frameEl.style.display = 'none'; assetsPanel.style.display = 'none'; emptyEl.style.display = 'flex'; }

    btnAdd.onclick = async () => {
      const res = await window.AppAPI.addModuleViaPicker();
      if (res.ok){ setStatus('Module added.'); refreshList(); }
      else setStatus('Canceled or failed. ' + (res.message||''));
    };
    btnOpenFolder.onclick = async () => { await window.AppAPI.openModulesFolder(); setStatus('Opened modules folder in Explorer.'); };

    // -------- Assets modern UI ----------
    let cwd = ''; // relative to assets root
    let isGrid = true;

    function setCount(n){ countEl.textContent = n + ' items'; }
    function updateSelCount(){ selCount.textContent = document.querySelectorAll('.sel:checked').length + ' selected'; }

    function extType(name){
      const ext = (name.split('.').pop() || '').toLowerCase();
      if (['png','jpg','jpeg','gif','webp'].includes(ext)) return 'image';
      if (['wav','mp3','ogg','flac'].includes(ext)) return 'audio';
      if (['json','tmx','tsx','txt','csv'].includes(ext)) return 'data';
      return 'other';
    }

    function makeCard(item){
      const type = item.isDir ? 'dir' : extType(item.name);
      const card = document.createElement('div'); card.className='card';
      card.tabIndex = 0;
      card.dataset.name = item.name;
      card.dataset.type = type;
      card.dataset.size = item.isDir ? 'Folder' : (Math.max(1, Math.round(item.size/1024)) + ' KB');
      card.dataset.rel = (cwd?cwd+'/':'') + item.name;

      const pick = document.createElement('label'); pick.className='pick';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.className='sel'; pick.appendChild(cb);
      const thumb = document.createElement('div'); thumb.className='thumb' + (type==='image' ? '' : ' nonimg');
      if (type==='image'){
        const img = document.createElement('img'); img.loading='lazy';
        img.alt = item.name;
        img.setAttribute('data-rel', card.dataset.rel);
        thumb.appendChild(img);
        const io = new IntersectionObserver(async (ents)=>{
          for (const e of ents){ if (e.isIntersecting){ try{
            const rel = img.getAttribute('data-rel');
            const r = await window.AppAPI.assetsFileUrl(rel);
            if (r && r.ok && r.url){ img.src = r.url; }
          } catch{} io.unobserve(img); } }
        }, { rootMargin: '200px' });
        io.observe(img);
      } else {
        thumb.textContent = item.isDir ? '📁' : (type==='audio'?'🎵': (type==='data'?'📜':'📄'));
      }
      const meta = document.createElement('div'); meta.className='meta';
      const n = document.createElement('span'); n.className='n'; n.textContent = item.name;
      const s = document.createElement('span'); s.className='s'; s.textContent = card.dataset.size;
      meta.appendChild(n); meta.appendChild(s);

      card.appendChild(pick); card.appendChild(thumb); card.appendChild(meta);

      card.addEventListener('click', async (e)=>{
        if (e.target.classList.contains('sel')) return;
        if (item.isDir){ cwd = (cwd?cwd+'/':'') + item.name; await loadAssets(); return; }
        showPreview(card.dataset.rel, type, card.dataset.size, item.mtime);
      });

      return card;
    }

    function buildListFromGrid(items){
      listViewEl.innerHTML = '<div class="row header"><div></div><div>Name</div><div>Type/Size</div><div>Modified</div></div>';
      for (const it of items){
        const row = document.createElement('div'); row.className='row';
        const colPick = document.createElement('div'); const cb = document.createElement('input'); cb.type='checkbox'; cb.className='sel'; colPick.appendChild(cb);
        const colN = document.createElement('div'); colN.className='name';
        const type = it.isDir ? 'dir' : extType(it.name);
        if (type==='image'){ const im=document.createElement('img'); (async ()=>{ try{ const r=await window.AppAPI.assetsFileUrl((cwd?cwd+'/':'')+it.name); if(r&&r.ok&&r.url) im.src=r.url; }catch{} })(); colN.appendChild(im); }
        else { const ic=document.createElement('span'); ic.textContent = it.isDir?'📁':(type==='audio'?'🎵':(type==='data'?'📜':'📄')); ic.style.fontSize='18px'; colN.appendChild(ic); }
        const span = document.createElement('span'); span.className='n'; span.textContent=it.name; colN.appendChild(span);
        const colS = document.createElement('div'); colS.textContent = it.isDir ? 'Folder' : (type + ' • ' + Math.max(1, Math.round(it.size/1024)) + ' KB');
        const colM = document.createElement('div'); colM.textContent = new Date(it.mtime).toLocaleString();
        row.appendChild(colPick); row.appendChild(colN); row.appendChild(colS); row.appendChild(colM);
        listViewEl.appendChild(row);
      }
    }

    function applyFilters(){
      const q = (searchEl.value||'').toLowerCase().trim();
      const kind = filterEl.value;
      const cards = Array.from(gridEl.children);
      let visible = 0;
      for (const card of cards){
        const name = card.dataset.name.toLowerCase();
        const type = card.dataset.type;
        const ok = (!q || name.includes(q)) && (kind==='all' || type===kind);
        card.hidden = !ok;
        if (ok) visible++;
      }
      setCount(visible);
      const items = [];
      for (let i=0;i<cards.length;i++){
        if (cards[i].hidden) continue;
        const it = currentItems[i];
        if (it) items.push(it);
      }
      buildListFromGrid(items);
    }

    let currentItems = [];
    async function loadAssets() {
      const res = await window.AppAPI.assetsList(cwd);
      if (!res.ok){ setStatus('Assets error: ' + (res.message||'failed')); return; }
      cwd = res.cwd || '';
      gridEl.innerHTML = '';
      currentItems = (res.items || []).sort((a,b)=> a.isDir===b.isDir ? a.name.localeCompare(b.name) : (a.isDir?-1:1));
      for (const it of currentItems) gridEl.appendChild(makeCard(it));
      setCount(currentItems.length);
      applyFilters();
    }

    function showAssets(){
      frameEl.style.display = 'none';
      emptyEl.style.display = 'none';
      assetsPanel.style.display = 'grid';
      loadAssets();
      setStatus('Assets opened.');
    }
    btnOpenAssets.onclick = showAssets;
    linkAssets.onclick = showAssets;

    // Toolbar buttons
    toggleViewBtn.addEventListener('click', ()=>{
      isGrid = !isGrid;
      gridEl.style.display = isGrid ? 'grid' : 'none';
      listViewEl.style.display = isGrid ? 'none' : 'block';
      toggleViewBtn.textContent = isGrid ? 'Grid View' : 'List View';
    });
    btnUp.onclick = async () => { const r = await window.AppAPI.assetsCwdUp(cwd); if (r.ok){ cwd = r.path || ''; loadAssets(); } };
    btnNewFolder.onclick = async () => {
      const name = prompt('Folder name:', 'New_Folder'); if (!name) return;
      const r = await window.AppAPI.assetsMkdir(cwd, name);
      if (r.ok) { setStatus('Folder created.'); loadAssets(); } else setStatus('Could not create folder. '+(r.message||''));
    };
    filePicker.addEventListener('change', async (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      const r = await window.AppAPI.assetsUpload(cwd, f.path);
      if (r.ok) { setStatus('File uploaded.'); loadAssets(); } else setStatus('Upload failed. '+(r.message||''));
      filePicker.value = '';
    });
    btnOpenAssetsFolder.onclick = async ()=> {
      const r = await window.AppAPI.assetsOpenFolder();
      if (r.ok) setStatus('Opened in Explorer.'); else setStatus('Open failed. ' + (r.message||''));
    };
    btnChangeAssets.onclick = async ()=> {
      const r = await window.AppAPI.assetsChooseRoot();
      if (r.ok) { setStatus('Assets location updated.'); cwd = ''; loadAssets(); }
      else { setStatus('Assets location not changed. ' + (r.message || '')); }
    };
    searchEl.addEventListener('input', applyFilters);
    filterEl.addEventListener('change', applyFilters);
    document.addEventListener('change', (e)=>{ if(e.target.classList.contains('sel')) updateSelCount(); });

    // Inspector preview
    function escapeHTML(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    async function showPreview(rel, type, size, mtime){
      if (type==='image'){
        const r = await window.AppAPI.assetsFileUrl(rel);
        inspector.innerHTML = r && r.ok && r.url ? ('<div style="text-align:center"><img src="'+r.url+'" style="max-width:100%;image-rendering:pixelated"/></div>') : '<div>No preview.</div>';
      } else if (type==='audio'){
        const r = await window.AppAPI.assetsFileUrl(rel);
        inspector.innerHTML = r && r.ok && r.url ? ('<audio controls src="'+r.url+'" style="width:100%"></audio>') : '<div>No preview.</div>';
      } else if (type==='data'){
        const r = await window.AppAPI.assetsReadText(rel);
        inspector.innerHTML = r && r.ok ? ('<div class="pre">'+escapeHTML(r.text)+'</div>') : '<div>No preview.</div>';
      } else {
        inspector.innerHTML = '<div style="color:#e0d7ea">No preview available.</div>';
      }
      const meta = document.createElement('div'); meta.style.marginTop='8px'; meta.style.color='#e0d7ea';
      meta.textContent = rel + ' • ' + size + (mtime?(' • '+ new Date(mtime).toLocaleString()):'');
      inspector.appendChild(meta);
    }

    // Context menu
    function openMenu(x, y, rel, type){
      ctxTarget = { rel, type };
      ctx.style.left = x + 'px'; ctx.style.top = y + 'px';
      ctx.classList.add('open'); ctx.setAttribute('aria-hidden','false');
    }
    function closeMenu(){
      ctx.classList.remove('open'); ctx.setAttribute('aria-hidden','true'); ctxTarget = null;
    }
    document.addEventListener('contextmenu', (e)=>{
      const card = e.target.closest('.card');
      if(card){
        e.preventDefault();
        openMenu(e.clientX, e.clientY, card.dataset.rel, card.dataset.type);
      } else closeMenu();
    });
    document.addEventListener('click', (e)=>{ if(!e.target.closest('#ctx')) closeMenu(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });

    ctx.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-act]'); if(!btn || !ctxTarget) return;
      const act = btn.getAttribute('data-act'); const rel = ctxTarget.rel;
      if (act==='open'){
        const item = currentItems.find(it => ((cwd?cwd+'/':'')+it.name) === rel);
        if (item && item.isDir){ cwd = rel; await loadAssets(); }
        else {
          const type = extType(rel);
          showPreview(rel, type, '', null);
        }
      }
      if (act==='rename'){
        const base = rel.split('/'); const oldName = base.pop(); const dir = base.join('/');
        const to = prompt('Rename to:', oldName); if (!to) return;
        const r = await window.AppAPI.assetsRename(dir, oldName, to);
        if (r.ok) { setStatus('Renamed.'); loadAssets(); } else setStatus('Rename failed. '+(r.message||''));
      }
      if (act==='move'){
        const to = prompt('Move to (path within assets):', rel); if (!to) return;
        const r = await window.AppAPI.assetsMove(rel, to);
        if (r.ok) { setStatus('Moved.'); loadAssets(); } else setStatus('Move failed. '+(r.message||''));
      }
      if (act==='duplicate'){
        const r = await window.AppAPI.assetsDuplicate(rel);
        if (r.ok) { setStatus('Duplicated.'); loadAssets(); } else setStatus('Duplicate failed. '+(r.message||''));
      }
      if (act==='delete'){
        if (!confirm('Delete '+rel+' ?')) return;
        const r = await window.AppAPI.assetsDelete(rel);
        if (r.ok) { setStatus('Deleted.'); loadAssets(); } else setStatus('Delete failed. '+(r.message||''));
      }
      closeMenu();
    });

    // Init
    window.addEventListener('DOMContentLoaded', () => {
      try {
        if (!window.AppAPI) throw new Error('Preload AppAPI not available');
        refreshList();
        showEmpty();
      } catch (e) {
        console.error('[init] failed:', e);
        const warn = document.createElement('div');
        warn.style.cssText = 'position:fixed;left:12px;bottom:12px;padding:8px 10px;border:1px solid #7f1d1d;background:#450a0a;color:#fecaca;border-radius:8px;font:12px/1.3 system-ui,Segoe UI,Roboto,sans-serif;z-index:99999';
        warn.textContent = 'Renderer init error: ' + String(e.message || e);
        document.body.appendChild(warn);
      }
    });
  </script>
</body>
</html>
